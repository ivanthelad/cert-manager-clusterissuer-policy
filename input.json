package kubernetes.admission

# Deny by default
default allow = false

# Allow any request that isn't creating/updating a Certificate
allow {
    input.request.kind.kind != "Certificate"
}

# Allow Customer A to use only IssuerA
allow {
    input.request.kind.kind == "Certificate"
    input.request.namespace == "customer-a-namespace"
    input.request.object.spec.issuerRef.name == "IssuerA"
    input.request.object.spec.issuerRef.kind == "ClusterIssuer"
}

# Allow Customer B to use only IssuerB
allow {
    input.request.kind.kind == "Certificate"
    input.request.namespace == "customer-b-namespace"
    input.request.object.spec.issuerRef.name == "IssuerB"
    input.request.object.spec.issuerRef.kind == "ClusterIssuer"
}

# Deny any other combination
deny[msg] {
    input.request.kind.kind == "Certificate"
    not allow
    msg := sprintf("Namespace %v cannot use ClusterIssuer %v", [input.request.namespace, input.request.object.spec.issuerRef.name])
}